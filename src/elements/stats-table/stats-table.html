<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<dom-module id="stats-table">
  <template>
    <div class="table">
      <div class="header-row">
        <div class="header">Tag Name</div>
        <div class="header">Count</div>
        <div class="header">Total Time</div>
        <div class="header">Created</div>
        <div class="header">Attached</div>
        <div class="header">Detached</div>
        <div class="header">Attributes</div>
        <div class="header">Data</div>
      </div>
      <template is="dom-repeat" items="[[stats]]">
        <style>
          div.table {
            display: table;
            border-collapse: collapse;
            margin: 8px 0;
          }
          div.row, div.header-row {
            display: table-row;
          }
          div.row:hover {
            background-color: var(--paper-blue-100);
          }
          div.header, div.cell {
            display: table-cell;
            padding: 4px 8px;
            border: solid 1px #aaa;
            position: relative;
          }
          div.fill {
            position: absolute;
            height: 100%;
            top: 0;
            right: 0;
          }
          span.label {
            position: relative;
          }
          div.header {
            @apply(--paper-font-body1);
            font-size: 10px;
          }
          div.cell {
            text-align: right;
            @apply(--paper-font-code1);
            font-size: 10px;
          }
          div.cell.total {
            font-weight: bold !important;
          }
          div.cell.name {
            text-align: left;
            color: var(--paper-pink-700);
          }
        </style>
        <div class="row">
          <div class="cell name">{{item.tagName}}</div>
          <div class="cell">{{item.count}}</div>
          <div class="cell total">
            <div class="fill" style$="[[_style(item, 'totalTime', stats, allTagsStats)]]"></div>
            <span class="label">[[_num(item.totalTime)]]</span>
          </div>
          <div class="cell">
            <div class="fill" style$="[[_style(item, 'created', stats, allTagsStats)]]"></div>
            <span class="label">[[_num(item.created)]]</span>
          </div>
          <div class="cell">
            <div class="fill" style$="[[_style(item, 'attached', stats, allTagsStats)]]"></div>
            <span class="label">[[_num(item.attached)]]</span>
          </div>
          <div class="cell">
            <div class="fill" style$="[[_style(item, 'detached', stats, allTagsStats)]]"></div>
            <span class="label">[[_num(item.detached)]]</span>
          </div>
          <div class="cell">
            <div class="fill" style$="[[_style(item, 'attributeChanged', stats, allTagsStats)]]"></div>
            <span class="label">[[_num(item.attributeChanged)]]</span>
          </div>
          <div class="cell">
            <div class="fill" style$="[[_style(item, 'data', stats, allTagsStats)]]"></div>
            <span class="label">[[_num(item.data)}}</span>
          </div>
        </div>
      </template>
    </div>
  </template>

  <script>
    (function() {
      'use strict';
      let precision = 2;

      Polymer({
        is: 'stats-table',
        properties: {
          stats: Array,
          allTagsStats: Object
        },
        _num(n) {
          return (typeof n === 'number') ? n.toFixed(precision) : '';
        },
        _maxAcross(props, stats) {
          return stats.reduce((prev, v) => {
            let max = prev;

            props.forEach((kv) => {
              if (v[kv] > max) {
                max = v[kv];
              }
            })

            return max;
          }, 0);
        },
        _style(item, property, stats, allTagsStats) {
          if (item === allTagsStats) {
            return '';
          }

          //todo: memoize
          let maxAcross = this._maxAcross(
              ['created', 'attached', 'detached', 'attributeChanged', 'data', 'totalTime'],
              stats.filter((v) => v.tagName !== 'All Custom Elements'));
          let percent = item[property] / maxAcross;
          let alpha = Math.sqrt(percent);

          if (property == 'totalTime') {
            if (allTagsStats.totalTime == 0) {
              return '';
            }
            return `background: rgba(244, 67, 54, ${alpha}); width: ${percent * 100}%`;
          }

          if (this.maxCallbackTime == 0) {
            return '';
          }
          return `background: rgba(255, 152, 0, ${alpha}); width: ${percent * 100}%`;
        }
          });
    })();
  </script>
</dom-module>
